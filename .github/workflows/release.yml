name: Release

on:
  push:
    tags:
      - 'nmrs-v*'
      - 'gui-v*'

jobs:
  release:
    name: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Parse tag info
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          
          # Determine crate from tag prefix
          if [[ "$TAG" == nmrs-v* ]]; then
            CRATE="nmrs"
            VERSION_FULL=${TAG#nmrs-v}
          elif [[ "$TAG" == gui-v* ]]; then
            CRATE="nmrs-gui"
            VERSION_FULL=${TAG#gui-v}
          else
            echo "Unknown tag format: $TAG"
            exit 1
          fi
          
          # Parse version and release type
          if [[ "$VERSION_FULL" == *-beta ]]; then
            VERSION=${VERSION_FULL%-beta}
            RELEASE_TYPE="beta"
          else
            VERSION=$VERSION_FULL
            RELEASE_TYPE="stable"
          fi
          
          echo "CRATE=$CRATE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV
          
          echo "Parsed: crate=$CRATE version=$VERSION type=$RELEASE_TYPE"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgirepository1.0-dev \
            libgdk-pixbuf2.0-dev \
            libpango1.0-dev \
            libcairo2-dev \
            libgtk-4-dev \
            libadwaita-1-dev

      - name: Verify build
        run: cargo build --release --package ${{ env.CRATE }}

      - name: Extract release notes
        run: |
          python3 scripts/extract_release_notes.py "${{ env.VERSION }}" "${{ env.RELEASE_TYPE }}" --crate "${{ env.CRATE }}" RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.CRATE }} ${{ env.VERSION }}${{ env.RELEASE_TYPE == 'beta' && '-beta' || '' }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ env.RELEASE_TYPE == 'beta' }}

  # Optional: Update AUR package for nmrs releases
  update-aur:
    name: update-aur
    needs: release
    if: startsWith(github.ref, 'refs/tags/nmrs-v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse version from tag
        run: |
          TAG=${GITHUB_REF#refs/tags/nmrs-v}
          if [[ "$TAG" == *-beta ]]; then
            VERSION=${TAG%-beta}
            RELEASE_TYPE="beta"
          else
            VERSION=$TAG
            RELEASE_TYPE="stable"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV

      - name: Update AUR Package
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          if [ -z "$AUR_SSH_PRIVATE_KEY" ]; then
            echo "⚠ AUR_SSH_PRIVATE_KEY secret not set, skipping AUR update"
            echo "To enable AUR updates, add your AUR SSH private key as a GitHub secret"
            exit 0
          fi
          
          # Setup SSH for AUR
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
          
          cat >> ~/.ssh/config << EOF
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur_key
            User aur
          EOF
          
          # Clone AUR repo
          if ! git clone ssh://aur@aur.archlinux.org/nmrs.git /tmp/nmrs-aur; then
            echo "✗ Failed to clone AUR repo"
            exit 0
          fi
          
          # Copy PKGBUILD
          if [ -f "PKGBUILD" ]; then
            cp PKGBUILD /tmp/nmrs-aur/
          else
            echo "✗ PKGBUILD not found"
            exit 1
          fi
          
          cd /tmp/nmrs-aur
          
          git config user.name "cachebag"
          git config user.email "cachebag@users.noreply.github.com"
          git add PKGBUILD
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update to ${{ env.VERSION }}"
            echo "⚠ Note: Run 'updpkgsums && makepkg --printsrcinfo > .SRCINFO' locally and push"
            # Uncomment to auto-push (requires checksums to be pre-updated):
            # git push origin master
          fi
