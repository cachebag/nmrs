#!/usr/bin/env bash
# Pre-commit hook for nmrs
# Place this in .git/hooks/pre-commit and chmod +x

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Check if there are any staged files
if git diff --cached --quiet; then
  echo -e "${YELLOW}No staged changes, skipping checks${NC}"
  exit 0
fi

# Get list of staged files
STAGED_RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
STAGED_NIX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.nix$' || true)
STAGED_CARGO_LOCK=$(git diff --cached --name-only --diff-filter=ACM | grep 'Cargo\.lock$' || true)

# 1. Rust formatting
if [ -n "$STAGED_RUST_FILES" ]; then
  echo -e "${YELLOW}[1/6] Running cargo fmt...${NC}"
  cargo fmt --all
  # Re-add formatted files
  git add -u
  echo -e "${GREEN}✓ Rust formatting complete${NC}"
else
  echo -e "${YELLOW}[1/6] No Rust files to format${NC}"
fi

# 2. Cargo check
if [ -n "$STAGED_RUST_FILES" ] || [ -n "$STAGED_CARGO_LOCK" ]; then
  echo -e "${YELLOW}[2/6] Running cargo check...${NC}"
  if cargo check --all-features --workspace; then
    echo -e "${GREEN}✓ Cargo check passed${NC}"
  else
    echo -e "${RED}✗ Cargo check failed${NC}"
    exit 1
  fi
else
  echo -e "${YELLOW}[2/6] Skipping cargo check${NC}"
fi

# 3. Clippy linting
if [ -n "$STAGED_RUST_FILES" ]; then
  echo -e "${YELLOW}[3/6] Running cargo clippy...${NC}"
  if cargo clippy --all-targets --all-features -- -D warnings; then
    echo -e "${GREEN}✓ Clippy passed${NC}"
  else
    echo -e "${RED}✗ Clippy found issues${NC}"
    exit 1
  fi
else
  echo -e "${YELLOW}[3/6] Skipping clippy${NC}"
fi

# 4. Run tests (only for nmrs library, not GUI)
if [ -n "$STAGED_RUST_FILES" ]; then
  echo -e "${YELLOW}[4/6] Running tests...${NC}"
  if cargo test -p nmrs --lib; then
    echo -e "${GREEN}✓ Tests passed${NC}"
  else
    echo -e "${RED}✗ Tests failed${NC}"
    exit 1
  fi
else
  echo -e "${YELLOW}[4/6] Skipping tests${NC}"
fi

# 5. Nix formatting
if [ -n "$STAGED_NIX_FILES" ]; then
  echo -e "${YELLOW}[5/6] Formatting Nix files...${NC}"
  if command -v nixpkgs-fmt &> /dev/null; then
    nixpkgs-fmt $STAGED_NIX_FILES
    git add $STAGED_NIX_FILES
    echo -e "${GREEN}✓ Nix formatting complete${NC}"
  else
    echo -e "${YELLOW}⚠ nixpkgs-fmt not found, skipping Nix formatting${NC}"
  fi
else
  echo -e "${YELLOW}[5/6] No Nix files to format${NC}"
fi

# 6. Nix build check and hash auto-fix
if [ -n "$STAGED_CARGO_LOCK" ] || [ -n "$STAGED_NIX_FILES" ]; then
  echo -e "${YELLOW}[6/6] Checking Nix build...${NC}"
  
  if command -v nix &> /dev/null; then
    if nix build -f default.nix 2>/dev/null; then
      echo -e "${GREEN}✓ Nix build succeeded${NC}"
    else
      echo -e "${YELLOW}⚠ Nix build failed - attempting to auto-fix hash...${NC}"
      
      # Try to auto-fix with determinate-nixd
      if command -v determinate-nixd &> /dev/null; then
        determinate-nixd fix hashes --auto-apply
        git add default.nix package.nix 2>/dev/null || true
        echo -e "${GREEN}✓ Nix hashes updated automatically${NC}"
        
        # Retry build
        if nix build -f default.nix; then
          echo -e "${GREEN}✓ Nix build succeeded after hash update${NC}"
        else
          echo -e "${RED}✗ Nix build still failing${NC}"
          exit 1
        fi
      else
        echo -e "${RED}✗ Nix build failed and determinate-nixd not available${NC}"
        echo -e "${YELLOW}Install with: nix profile install nixpkgs#determinate-nixd${NC}"
        exit 1
      fi
    fi
  else
    echo -e "${YELLOW}⚠ Nix not found, skipping Nix checks${NC}"
  fi
else
  echo -e "${YELLOW}[6/6] Skipping Nix build check${NC}"
fi

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"
